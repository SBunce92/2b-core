#!/bin/bash
# Update vault's 2b-core system files from latest
# Usage: 2b-update [--dry-run]

set -e

VAULT_DIR="${VAULT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)}"
REPO="git@github.com:SBunce92/2b-core.git"
TMP_DIR="/tmp/2b-core-update-$$"
VERSION_FILE="$VAULT_DIR/_claude/.2b-core-version"
DRY_RUN=false

if [[ "$1" == "--dry-run" ]]; then
    DRY_RUN=true
    echo "[DRY RUN MODE]"
fi

# Current version
CURRENT_VERSION="none"
if [[ -f "$VERSION_FILE" ]]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE")
fi
echo "Current version: $CURRENT_VERSION"

# Clone latest
echo "Fetching latest 2b-core..."
git clone --depth 1 --quiet "$REPO" "$TMP_DIR"
NEW_VERSION=$(cd "$TMP_DIR" && git rev-parse --short HEAD)
echo "Latest version:  $NEW_VERSION"

if [[ "$CURRENT_VERSION" == "$NEW_VERSION" ]]; then
    echo "Already up to date."
    rm -rf "$TMP_DIR"
    exit 0
fi

echo ""
echo "=== Changes ==="

# Sync entire _claude/core/ directory
UPDATED=()
ADDED=()

# Find all files in 2b-core's _claude/core/
while IFS= read -r -d '' src; do
    rel_path="${src#$TMP_DIR/}"
    dst="$VAULT_DIR/$rel_path"

    # Ensure destination directory exists
    mkdir -p "$(dirname "$dst")"

    if [[ -f "$dst" ]]; then
        if ! diff -q "$src" "$dst" > /dev/null 2>&1; then
            echo ""
            echo "--- $rel_path ---"
            diff -u "$dst" "$src" || true
            UPDATED+=("$rel_path")
            if [[ "$DRY_RUN" == false ]]; then
                cp "$src" "$dst"
                chmod +x "$dst" 2>/dev/null || true
            fi
        fi
    else
        echo "NEW: $rel_path"
        ADDED+=("$rel_path")
        if [[ "$DRY_RUN" == false ]]; then
            cp "$src" "$dst"
            chmod +x "$dst" 2>/dev/null || true
        fi
    fi
done < <(find "$TMP_DIR/_claude/core" -type f -print0 2>/dev/null)

# Also sync projects/_template/ if it exists
if [[ -d "$TMP_DIR/projects/_template" ]]; then
    while IFS= read -r -d '' src; do
        rel_path="${src#$TMP_DIR/}"
        dst="$VAULT_DIR/$rel_path"
        mkdir -p "$(dirname "$dst")"

        if [[ -f "$dst" ]]; then
            if ! diff -q "$src" "$dst" > /dev/null 2>&1; then
                echo ""
                echo "--- $rel_path ---"
                diff -u "$dst" "$src" || true
                UPDATED+=("$rel_path")
                if [[ "$DRY_RUN" == false ]]; then
                    cp "$src" "$dst"
                fi
            fi
        else
            echo "NEW: $rel_path"
            ADDED+=("$rel_path")
            if [[ "$DRY_RUN" == false ]]; then
                cp "$src" "$dst"
            fi
        fi
    done < <(find "$TMP_DIR/projects/_template" -type f -print0 2>/dev/null)
fi

# Update version
if [[ "$DRY_RUN" == false ]]; then
    echo "$NEW_VERSION" > "$VERSION_FILE"
fi

# Cleanup
rm -rf "$TMP_DIR"

echo ""
echo "=== Summary ==="
TOTAL=$((${#UPDATED[@]} + ${#ADDED[@]}))
if [[ $TOTAL -eq 0 ]]; then
    echo "No file changes (version updated only)"
else
    if [[ ${#UPDATED[@]} -gt 0 ]]; then
        echo "Updated ${#UPDATED[@]} file(s):"
        for f in "${UPDATED[@]}"; do
            echo "  ~ $f"
        done
    fi
    if [[ ${#ADDED[@]} -gt 0 ]]; then
        echo "Added ${#ADDED[@]} file(s):"
        for f in "${ADDED[@]}"; do
            echo "  + $f"
        done
    fi
fi

if [[ "$DRY_RUN" == false ]]; then
    echo ""
    echo "Version: $CURRENT_VERSION â†’ $NEW_VERSION"
    echo ""
    echo "Run 'git add -A && git commit -m \"Update 2b-core to $NEW_VERSION\"' to commit"
else
    echo ""
    echo "[DRY RUN] No changes made"
fi
