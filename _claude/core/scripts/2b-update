#!/bin/bash
# Update vault's 2b-core system files from latest
# Usage: 2b-update [--dry-run]

set -e

VAULT_DIR="${VAULT_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)}"
REPO="git@github.com:SBunce92/2b-core.git"
TMP_DIR="/tmp/2b-core-update-$$"
VERSION_FILE="$VAULT_DIR/_claude/.2b-core-version"
DRY_RUN=false

if [[ "$1" == "--dry-run" ]]; then
    DRY_RUN=true
    echo "[DRY RUN MODE]"
fi

# Current version
CURRENT_VERSION="none"
if [[ -f "$VERSION_FILE" ]]; then
    CURRENT_VERSION=$(cat "$VERSION_FILE")
fi
echo "Current version: $CURRENT_VERSION"

# Clone latest
echo "Fetching latest 2b-core..."
git clone --depth 1 --quiet "$REPO" "$TMP_DIR"
NEW_VERSION=$(cd "$TMP_DIR" && git rev-parse --short HEAD)
echo "Latest version:  $NEW_VERSION"

if [[ "$CURRENT_VERSION" == "$NEW_VERSION" ]]; then
    echo "Already up to date."
    rm -rf "$TMP_DIR"
    exit 0
fi

echo ""
echo "=== Changes ==="

# Directories to sync from 2b-core (the "meta layer")
SYNC_DIRS=(
    "_claude/core"
    "_claude/hooks"
    "projects/_template"
)

UPDATED=()
ADDED=()

# Helper function to sync a directory
sync_dir() {
    local src_dir="$1"
    [[ -d "$TMP_DIR/$src_dir" ]] || return 0

    while IFS= read -r -d '' src; do
        rel_path="${src#$TMP_DIR/}"
        dst="$VAULT_DIR/$rel_path"
        mkdir -p "$(dirname "$dst")"

        if [[ -f "$dst" ]]; then
            if ! diff -q "$src" "$dst" > /dev/null 2>&1; then
                echo ""
                echo "--- $rel_path ---"
                diff -u "$dst" "$src" || true
                UPDATED+=("$rel_path")
                if [[ "$DRY_RUN" == false ]]; then
                    cp "$src" "$dst"
                    chmod +x "$dst" 2>/dev/null || true
                fi
            fi
        else
            echo "NEW: $rel_path"
            ADDED+=("$rel_path")
            if [[ "$DRY_RUN" == false ]]; then
                cp "$src" "$dst"
                chmod +x "$dst" 2>/dev/null || true
            fi
        fi
    done < <(find "$TMP_DIR/$src_dir" -type f -print0 2>/dev/null)
}

# Sync all meta layer directories
for dir in "${SYNC_DIRS[@]}"; do
    sync_dir "$dir"
done

# Also sync CLAUDE.md if it exists (AI instructions template)
if [[ -f "$TMP_DIR/CLAUDE.md" ]]; then
    if [[ -f "$VAULT_DIR/CLAUDE.md" ]]; then
        if ! diff -q "$TMP_DIR/CLAUDE.md" "$VAULT_DIR/CLAUDE.md" > /dev/null 2>&1; then
            echo ""
            echo "--- CLAUDE.md ---"
            echo "(skipped - vault has local customizations)"
        fi
    else
        echo "NEW: CLAUDE.md"
        ADDED+=("CLAUDE.md")
        if [[ "$DRY_RUN" == false ]]; then
            cp "$TMP_DIR/CLAUDE.md" "$VAULT_DIR/CLAUDE.md"
        fi
    fi
fi

# Update version
if [[ "$DRY_RUN" == false ]]; then
    echo "$NEW_VERSION" > "$VERSION_FILE"
fi

# Cleanup
rm -rf "$TMP_DIR"

echo ""
echo "=== Summary ==="
TOTAL=$((${#UPDATED[@]} + ${#ADDED[@]}))
if [[ $TOTAL -eq 0 ]]; then
    echo "No file changes (version updated only)"
else
    if [[ ${#UPDATED[@]} -gt 0 ]]; then
        echo "Updated ${#UPDATED[@]} file(s):"
        for f in "${UPDATED[@]}"; do
            echo "  ~ $f"
        done
    fi
    if [[ ${#ADDED[@]} -gt 0 ]]; then
        echo "Added ${#ADDED[@]} file(s):"
        for f in "${ADDED[@]}"; do
            echo "  + $f"
        done
    fi
fi

if [[ "$DRY_RUN" == false ]]; then
    echo ""
    echo "Version: $CURRENT_VERSION â†’ $NEW_VERSION"
    echo ""
    echo "Run 'git add -A && git commit -m \"Update 2b-core to $NEW_VERSION\"' to commit"
else
    echo ""
    echo "[DRY RUN] No changes made"
fi
